# BUG-2026-02-06-002 Direction Matrix

## Hard Gates

1. `BUG-2026-02-06-002` returns `Int` in both unchecked and checked pipelines.
2. Let-polymorphism remains binder-level (no forced `make` specialization to codomain `Int`).
3. Focused regressions remain green:
   - `generalizes reused constructors via make const`
   - `redirected let-use sites keep polymorphic schemes`
   - `BUG-2026-02-08-004` sentinel behavior (unless intentionally revised with dedicated tests)
4. Full verification passes: `cabal build all && cabal test`.
5. Result is thesis-defensible against `papers/these-finale-english.txt`.

## Matrix Table

| Direction | Patch Summary | Bug Target | Thesis Gate | Focused Regression | Full Suite | Verdict | Notes |
|-----------|---------------|------------|-------------|--------------------|------------|---------|-------|
| Baseline  | none          | FAIL       | FAIL        | n/a                | n/a        | n/a     | Phase 7 `TCLetTypeMismatch` |
| D1        | keep reachable non-rep binder when rep out-of-reach | FAIL | FAIL | PASS | n/a | FAIL | bug target stays 2/2 TCLetTypeMismatch |
| D2        | gate bound-var typeRoot fallback by gamma membership | FAIL | FAIL | PASS | n/a | FAIL | no change in strict bug target (2/2 fails) |
| D3        | deprioritize copy overrides in solved->base mapping + tighten binder meta copy provenance | FAIL | FAIL | PASS | n/a | FAIL | mapping deltas observed but bug target still fails |
| D4        | let scope/target reroute (`schemeRootId -> trivialRoot`) | FAIL | FAIL | FAIL | n/a | FAIL | introduces Phase 6 Φ invariant failures; reverted |
| D5        | always close let RHS with scheme wrapper | FAIL | FAIL | PASS* | n/a | FAIL | no strict-target improvement; reverted (*BUG-2026-02-08-004 matcher returned 0 examples) |
| D6        | use `solvedForGen` for Φ/reify/elab inputs | FAIL | FAIL | FAIL | n/a | FAIL | causes OpRaise translatability/invariant regressions; reverted |

## Baseline Failure Evidence (2026-02-09)

- Command:
  - `cabal test mlf2-test --test-show-details=direct --test-options='--match="BUG-2026-02-06-002 thesis target"'`
- Failure payload:
  - `unchecked pipeline failed: Phase 7 (type checking): TCLetTypeMismatch (TForall "a" Nothing (TForall "b" Nothing (TArrow TBottom (TBase (BaseTy {getBaseName = "Int"}))))) (TForall "a" Nothing (TForall "b" Nothing (TArrow (TVar "b") (TVar "a"))))`
  - `checked pipeline failed: Phase 7 (type checking): TCLetTypeMismatch (TForall "a" Nothing (TForall "b" Nothing (TArrow TBottom (TBase (BaseTy {getBaseName = "Int"}))))) (TForall "a" Nothing (TForall "b" Nothing (TArrow (TVar "b") (TVar "a"))))`

## Direction Command Sets

### D1 Commands

- `bash scripts/run-bug-2026-02-06-002-direction.sh`
- `cabal test mlf2-test --test-show-details=direct --test-options='--match="BUG-2026-02-06-002 thesis target"'`
- `cabal test mlf2-test --test-show-details=direct --test-options='--match="generalizes reused constructors via make const"'`
- `cabal test mlf2-test --test-show-details=direct --test-options='--match="redirected let-use sites keep polymorphic schemes"'`
- `cabal test mlf2-test --test-show-details=direct --test-options='--match="BUG-2026-02-08-004"'`

### D2 Commands

- `bash scripts/run-bug-2026-02-06-002-direction.sh`
- `cabal test mlf2-test --test-show-details=direct --test-options='--match="BUG-2026-02-06-002 thesis target"'`
- `cabal test mlf2-test --test-show-details=direct --test-options='--match="generalizes reused constructors via make const"'`
- `cabal test mlf2-test --test-show-details=direct --test-options='--match="redirected let-use sites keep polymorphic schemes"'`
- `cabal test mlf2-test --test-show-details=direct --test-options='--match="BUG-2026-02-08-004"'`

### D3 Commands

- `bash scripts/run-bug-2026-02-06-002-direction.sh`
- `cabal test mlf2-test --test-show-details=direct --test-options='--match="BUG-2026-02-06-002 thesis target"'`
- `cabal test mlf2-test --test-show-details=direct --test-options='--match="generalizes reused constructors via make const"'`
- `cabal test mlf2-test --test-show-details=direct --test-options='--match="redirected let-use sites keep polymorphic schemes"'`
- `cabal test mlf2-test --test-show-details=direct --test-options='--match="BUG-2026-02-08-004"'`

### D4 Commands

- `bash scripts/run-bug-2026-02-06-002-direction.sh`
- `cabal test mlf2-test --test-show-details=direct --test-options='--match="BUG-2026-02-06-002 thesis target"'`
- `cabal test mlf2-test --test-show-details=direct --test-options='--match="generalizes reused constructors via make const"'`
- `cabal test mlf2-test --test-show-details=direct --test-options='--match="redirected let-use sites keep polymorphic schemes"'`
- `cabal test mlf2-test --test-show-details=direct --test-options='--match="BUG-2026-02-08-004"'`

### D5 Commands

- `bash scripts/run-bug-2026-02-06-002-direction.sh`
- `cabal test mlf2-test --test-show-details=direct --test-options='--match="BUG-2026-02-06-002 thesis target"'`
- `cabal test mlf2-test --test-show-details=direct --test-options='--match="generalizes reused constructors via make const"'`
- `cabal test mlf2-test --test-show-details=direct --test-options='--match="redirected let-use sites keep polymorphic schemes"'`
- `cabal test mlf2-test --test-show-details=direct --test-options='--match="BUG-2026-02-08-004"'`

### D6 Commands

- `bash scripts/run-bug-2026-02-06-002-direction.sh`
- `cabal test mlf2-test --test-show-details=direct --test-options='--match="BUG-2026-02-06-002 thesis target"'`
- `cabal test mlf2-test --test-show-details=direct --test-options='--match="generalizes reused constructors via make const"'`
- `cabal test mlf2-test --test-show-details=direct --test-options='--match="redirected let-use sites keep polymorphic schemes"'`
- `cabal test mlf2-test --test-show-details=direct --test-options='--match="BUG-2026-02-08-004"'`

## Verdict Rubric

- Mark a direction `PASS` only when every hard gate is satisfied.
- Mark a direction `FAIL` immediately when any hard gate or focused regression fails.
- No partial passes: verdict is binary (`PASS` or `FAIL`).

## Rollback Policy

- Evaluate exactly one direction patch at a time.
- If a direction fails any gate, revert that patch before starting the next direction.
- Keep baseline harness and matrix logs intact across all direction experiments.

## Direction Results

### D1 Result (2026-02-10)

- Artifact dir: `tmp/direction-matrix/20260210-061921`
- Patch tested: retain a reachable binder when its solved/base representative is not reachable (binder-representative suppression relaxation).
- Focused outcomes:
  - `BUG-2026-02-06-002 thesis target`: **FAIL** (`2 examples, 2 failures`)
  - `generalizes reused constructors via make const`: **PASS**
  - `redirected let-use sites keep polymorphic schemes`: **PASS**
- Thesis gate verdict: **FAIL** (hard gate 1 not satisfied; mismatch family remains `TCLetTypeMismatch` with `TArrow TBottom ...`).
- Rollback: D1 source patch reverted; matrix notes retained.

### D2 Result (2026-02-10)

- Artifact dir: `tmp/direction-matrix/20260210-062107`
- Patch tested: tighten bound-var `typeRootFromBoundVar` fallback so `targetBoundUnderOtherGen` only applies when target is in gamma.
- Focused outcomes:
  - `BUG-2026-02-06-002 thesis target`: **FAIL** (`2 examples, 2 failures`)
  - `generalizes reused constructors via make const`: **PASS**
  - `redirected let-use sites keep polymorphic schemes`: **PASS**
- Thesis gate verdict: **FAIL** (strict bug target unchanged; mismatch family still `TCLetTypeMismatch`).
- Rollback: D2 source patch reverted; matrix notes retained.

### D3 Result (2026-02-10)

- Artifact dir: `tmp/direction-matrix/20260210-062356`
- Patch tested:
  - solved→base mapping precedence changed to keep canonical/base alignment before copy overrides;
  - copy provenance tightened so binder meta overrides require base-named binders.
- Focused outcomes:
  - `BUG-2026-02-06-002 thesis target`: **FAIL** (`2 examples, 2 failures`)
  - `generalizes reused constructors via make const`: **PASS**
  - `redirected let-use sites keep polymorphic schemes`: **PASS**
- Mapping/trace deltas observed:
  - `baseGammaSet` gained alias-related entry (`... [0,1,5,6,9,10] ...` vs prior `[0,1,5,6,10]`).
  - `generalizeAt` bound extras introduced `t25`, but scheme still hard-specialized to codomain `Int` in let elaboration trace.
- Thesis gate verdict: **FAIL** (bug target unresolved).
- Rollback: D3 source patch reverted; matrix notes retained.


### D4 Result (2026-02-10)

- Artifact dir: `tmp/direction-matrix/20260210-072848`
- Patch tested:
  - `src/MLF/Elab/Elaborate.hs`
  - let elaboration reroute for generalization target (`generalizeAtNode trivialRoot` instead of `schemeRootId`).
- Focused outcomes:
  - `BUG-2026-02-06-002 thesis target`: **FAIL** (`2 examples, 2 failures`, Phase 6 `PhiInvariantError`).
  - `generalizes reused constructors via make const`: **PASS**.
  - `redirected let-use sites keep polymorphic schemes`: **FAIL** (`PhiInvariantError "PhiReorder: missing binder identity..."`).
- Strict matrix outcome:
  - `BUG-2026-02-06-002 strict target matrix`: **FAIL** (`4 examples, 4 failures`) with new Phase 6 failures.
- Verdict: **FAIL**.
- Rollback: reverted `Elaborate.hs` D4 probe.

### D5 Result (2026-02-10)

- Artifact dir: `tmp/direction-matrix/20260210-073251`
- Patch tested:
  - `src/MLF/Elab/Elaborate.hs`
  - closure boundary probe: always use `closeTermWithSchemeSubst` at let RHS.
- Focused outcomes:
  - `BUG-2026-02-06-002 thesis target`: **FAIL** (unchanged mismatch family).
  - `generalizes reused constructors via make const`: **PASS**.
  - `redirected let-use sites keep polymorphic schemes`: **PASS**.
  - `BUG-2026-02-08-004`: matcher returned `0 examples` in this run (no signal).
- Strict matrix outcome:
  - `BUG-2026-02-06-002 strict target matrix`: **FAIL** (`4 examples, 4 failures`), essentially baseline shape.
- Verdict: **FAIL** (no hard-gate improvement).
- Rollback: reverted `Elaborate.hs` D5 probe.

### D6 Result (2026-02-10)

- Artifact dir: `tmp/direction-matrix/20260210-073025`
- Patch tested:
  - `src/MLF/Elab/Run/Pipeline.hs`
  - use `solvedForGen` for `eeResPhi`/`eeResReify` (state unification probe).
- Focused outcomes:
  - `BUG-2026-02-06-002 thesis target`: **FAIL** (new Phase 6 `PhiTranslatabilityError`/`PhiInvariantError` family).
  - `generalizes reused constructors via make const`: **PASS**.
  - `redirected let-use sites keep polymorphic schemes`: **FAIL** (`PhiInvariantError` with `OpRaise(non-spine,root)`).
- Strict matrix outcome:
  - `BUG-2026-02-06-002 strict target matrix`: **FAIL** (`4 examples, 4 failures`), shifted to Phase 6 translatability errors for 3/4 shapes.
- Verdict: **FAIL**.
- Rollback: reverted `Run/Pipeline.hs` D6 probe.

### Post-matrix coupled probe C1 (2026-02-10)

- Patch tested (retained):
  - `src/MLF/Constraint/Presolution/Plan/Normalize.hs`
  - broaden structured alias inlining in `simplifySchemeBindings`.
- Results:
  - `BUG-2026-02-06-002 strict target matrix`: improved from `4/4` failures to `3/4` failures.
  - `make-only` now passes.
  - focused regressions checked so far (`make const`, `redirected let-use`, H15 non-leak, witness suites): PASS.
- Interpretation:
  - Confirms one residual root cause is in scheme finalization/alias-body normalization (non-edge path).
  - Remaining failures are application-path codomain `TBottom`/`Int` lock-in.

### Post-matrix Ω probes C2 (2026-02-10, reverted)

- C2.1: binder-name fallback in `Omega.reifyTypeArg` for copy/bound-related graft args.
- C2.2: prefer `OpRaise(non-spine,root)` over candidate insertion when both available.

Outcome:
- Both probes were non-improving for hard gate 1 (`strict target matrix` remained `3 failures` after C1).
- Both probes were reverted.

### Post-matrix probe C3 (2026-02-10, reverted)

- Patch tested:
  - `src/MLF/Elab/Phi/Translate.hs`
  - fallback keep-binder-key derivation when target-binder keep-set is empty.
- Outcome:
  - no additional hard-gate improvement (`strict matrix` remained `3 failures` after C1).
  - introduced focused regression (`redirected let-use sites keep polymorphic schemes`), then reverted.

### Post-C1 probe C4 (2026-02-10, reverted)

- Patch tested:
  - `src/MLF/Elab/Inst.hs`
  - preserve `TVar` bounds in `instInsideFn` (do not drop to `Nothing`).
- Outcome:
  - strict matrix unchanged (`4 examples, 3 failures`).
  - focused regressions PASS; sentinel matrix `4 pending`.
- Verdict: non-improving; reverted.

### Post-C1 probe C5 (2026-02-10, reverted)

- Patch tested:
  - `src/MLF/Constraint/Presolution/WitnessCanon.hs`
  - skip `reorderWeakenWithEnv` in normalization (temporary no-reorder check).
- Outcome:
  - strict matrix unchanged (`4 examples, 3 failures`).
  - failing edge witness step shape remained effectively unchanged for hard bug path.
- Verdict: non-improving; reverted.

### Post-C1 probe C6 (2026-02-10, reverted)

- Patch tested:
  - `src/MLF/Elab/Phi/Omega.hs`
  - `graftArgFor` prefers `etBinderArgs` matching before copy-map fallback.
- Outcome:
  - strict matrix unchanged (`4 examples, 3 failures`).
  - failing reify still observed: `arg=NodeId 23` -> `ty=TBottom`.
- Verdict: non-improving; reverted.

### New diagnostic insight from C5/C6 cycle

- In failing `let-c1-apply-bool` edge-0, presolution pairing is structurally aligned:
  - `ewSteps` includes `OpGraft ... (binder 1)` and trace has `etBinderArgs` mapping `binder 1 -> arg 23`.
- Solved graph inspection shows `NodeId 23` is an unbounded `TyVar` (`tnBound = Nothing`).
- But Φ reification still produces `TBottom` for that arg in translation trace.
- Implication:
  - residual bug is likely in Φ reification/naming fallback behavior, not in witness pairing capture.

### Post-C1 probe C8 (2026-02-10, reverted)

- Patch tested:
  - `src/MLF/Elab/Phi/Omega.hs`
  - `traceArgMap.nameFor` fallback broadened to direct/copy-forward/copy-reverse binder key lookups.
- Outcome:
  - strict matrix unchanged (`4 examples, 3 failures`).
  - diagnostic improvement only: inferred map became populated for edge-0 (`a -> Int`, `b -> TBottom`).
- Interpretation:
  - binder-name resolution gap was real but non-root-causal for strict failure;
  - remaining blocker is still unbounded arg reification collapsing to `TBottom` under current no-fallback path.
- Verdict: reverted.

### Post-C1 probe C9 (2026-02-10, reverted)

- Patch tested:
  - `src/MLF/Elab/Phi/Omega.hs`
  - in `reifyTypeArg`, rescued unbounded `TBottom` arg reification to binder variable (`TVar binderName`) when binder identity/name is known.
- Outcome:
  - strict matrix unchanged (`4 examples, 3 failures`).
  - focused regressions PASS; sentinel matrix remains `4 pending`.
- Diagnostic:
  - trace confirms local effect (`chosenTy2=TVar "b"`, `InstInside (InstBot (TVar "b"))`) but no end-to-end behavior change.
- Verdict: reverted.

### Post-C1 probe C10 (2026-02-10, reverted)

- Patch tested:
  - `src/MLF/Elab/Phi/Translate.hs`
  - strengthened `remapSchemeInfoM` / `remapSchemeInfo` substitution remapping via direct/copy/reverse-copy binder lookup plus `etBinderArgs` alias synthesis.
- Outcome:
  - `BUG-2026-02-06-002 strict target matrix`: unchanged (`4 examples, 3 failures`).
  - focused guard tests: PASS.
  - sentinel matrix: `4 pending` (unchanged).
  - full BUG matcher: unchanged (`10 examples, 5 failures, 4 pending`).
- Verdict:
  - non-improving for strict target.
- Rollback:
  - reverted `src/MLF/Elab/Phi/Translate.hs`.

### Post-C1 probe C11 (2026-02-10, diagnostic-only; reverted)

- Patch tested:
  - `src/MLF/Elab/Phi/Omega.hs`
  - temporary `applyInst` operation-level tracing.
- Key evidence:
  - for failing edge-0, effective transformations are `OpGraft`, `OpGraft`, `OpWeaken`, `OpWeaken`.
  - no effective `OpRaise` transformation observed on the failing path.
  - collapse point is final weaken:
    - before: `TForall "u1" Nothing (TArrow Int (TArrow (TVar "u1") Int))`
    - after: `TArrow Int (TArrow TBottom Int)`.
- Interpretation:
  - residual codomain lock-in is a keep/elimination issue at weaken stage, not an OpRaise transformation bug in this path.
- Rollback:
  - reverted diagnostic patch.

### Post-C1 probe C12 (2026-02-10, reverted)

- Patch tested:
  - `src/MLF/Elab/Phi/Translate.hs`
  - fallback keep-key derivation from reachable right-type nodes when target binder set is empty.
- Outcome:
  - strict target still red (`4 examples, 3 failures`), with failure family shifted to `TCExpectedArrow`.
  - focused regressions introduced (notably `redirected let-use sites keep polymorphic schemes`).
- Verdict:
  - over-broad keep policy; non-viable.
- Rollback:
  - reverted `Translate.hs` probe.

### Post-C1 probe C13 (2026-02-10, reverted)

- Patch tested:
  - `src/MLF/Elab/Phi/Omega.hs`
  - in `OpWeaken`, skip elimination when binder bound matches rigid-unbounded alias shape.
- Outcome:
  - strict target matrix remained failing (`3` failures) with altered error mix (`TCExpectedArrow` in one shape).
  - focused regressions introduced (`redirected let-use ...`, H15 non-leak guard).
- Verdict:
  - non-viable heuristic.
- Rollback:
  - reverted `Omega.hs` probe.

### Post-C1 probe C14 (2026-02-10, reverted)

- Patch tested:
  - `src/MLF/Elab/Phi/Translate.hs`
  - derive keep-key target binders from `ewRoot` instead of `ewRight`.
- Outcome:
  - strict target unchanged (`3` failures).
  - focused guards PASS.
- Verdict:
  - non-improving for hard gate progression.
- Rollback:
  - reverted `Translate.hs` probe.

### Post-C1 probe C15 (2026-02-10, reverted)

- Patch tested:
  - `src/MLF/Elab/Phi/Translate.hs`
  - include canonicalized `etBinderArgs` arg nodes in Φ `namedSet`.
- Outcome:
  - strict target unchanged (`3` failures).
  - focused regression introduced (`redirected let-use sites keep polymorphic schemes`).
- Verdict:
  - non-viable broadening of naming scope.
- Rollback:
  - reverted `Translate.hs` probe.

### Post-C1 probe C16 (2026-02-10, reverted)

- Patch tested:
  - `src/MLF/Elab/Phi/Omega.hs`
  - standalone `OpWeaken` preserve guard for singleton-unbounded + rigid-alias pattern.
- Outcome:
  - strict target unchanged (`3` failures) with error-family shift.
  - focused regressions introduced (`redirected let-use ...`, H15 non-leak guard).
- Verdict:
  - non-viable.
- Rollback:
  - reverted `Omega.hs` probe.

### Post-C1 probe C17 (2026-02-10, upstream witness path; reverted)

- Patch tested:
  - `src/MLF/Constraint/Presolution/WitnessCanon.hs`
  - temporary normalization pass to prune `OpWeaken` for graft binders whose graft arg is unbounded var in mixed graft blocks.
- Outcome:
  - strict target unchanged (`3` failures), shifted to `TCExpectedArrow` family.
  - focused regression introduced (`does not leak solved-node names in make let mismatch`).
- Verdict:
  - non-viable.
- Rollback:
  - reverted `WitnessCanon.hs` probe.

### Post-C1 probe C18 (2026-02-10, retained)

- Patch tested:
  - `src/MLF/Elab/Phi/Omega.hs`
  - `reifyTypeArg`: rescue binder arg `TBottom` to binder TVar when binder name is known.
  - `OpGraft` binder path: detect delayed matching `OpWeaken` and translate as `InstApp`, consuming that delayed weaken.
- Outcome:
  - strict target matrix improved to `4 examples, 2 failures`.
  - newly passing strict case: `make-app keeps codomain Int without bottom-domain collapse`.
  - focused guards remained PASS; sentinel matrix stayed `4 pending`.
  - full matcher improved to `10 examples, 4 failures, 4 pending`.
- Remaining failures:
  - let-scheme mismatch family (`let-c1-return`, `let-c1-apply-bool`).

### Post-C1 probe C19 (2026-02-10, reverted)

- Patch tested:
  - `src/MLF/Elab/Elaborate.hs` (`ALet` branch)
  - temporary fallback to derive let scheme from elaborated RHS type when generalized scheme mismatched.
- Outcome:
  - regressed strict matrix from C18 (`2` failures) back to `3` failures.
  - `make-app` regressed with `TCInstantiationError InstElim ... expects forall`.
- Verdict:
  - non-viable; reverted.

### Post-C1 probe C20 (2026-02-10, reverted)

- Patch family tested (temporary `ALet` fallback in `src/MLF/Elab/Elaborate.hs`):
  - derive fallback let-scheme from RHS type when generalized scheme mismatches.
  - variant B used env-aware RHS checking (`typeCheckWithEnv`) so fallback could activate on failing let-c1 paths.

- Outcome:
  - best variant reached `strict matrix: 4 examples, 1 failure`.
  - remaining strict fail: `let-c1-apply-bool` with `TCArgumentMismatch` (`forall t16<=Bool. t16 -> ⊥` applied to `Bool`).
  - focused regression introduced in H15 guard (`does not leak solved-node names in make let mismatch`), so patch is rejected.

- Verdict:
  - non-viable as retained fix under guard policy; reverted to C18 baseline.

### Post-C1 probe C21/C21.1 (2026-02-10, retained)

- Patch set retained:
  - `src/MLF/Elab/Elaborate.hs`
    - C21: ALet env-aware fallback scheme derivation (`typeCheckWithEnv` + free-var generalization + alpha-equivalence gate, keeping `subst0`).
    - C21.1: AApp non-polymorphic arg repair extended to `InstApp TForall{}` on fun side.

- Outcome:
  - strict target matrix now fully green (`4/4`).
  - thesis target checks pass (checked + unchecked).
  - focused guards pass (including H15 non-leak).
  - sentinel matrix intentionally remains `4 pending`.

- Interpretation:
  - residual failures were split across let-scheme selection and app-side instantiation argument shaping; resolving both together removed the last codomain/argument lock-in without reopening H15 leakage behavior.

### 2026-02-10 step-1/2/3 batch

- Sentinel matrix in `PipelineSpec` was graduated from `pendingWith` to concrete assertions; case names unchanged.
- `BUG-2026-02-06-002` matcher now reports `10 examples, 0 failures`.
- Full-repo gate (`cabal build all && cabal test`) is still red due 5 broader regressions outside this bug-specific matrix.
