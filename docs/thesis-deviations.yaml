---
version: 1
deviations:
  - id: DEV-STEPINTRO-NOT-OMEGA
    chapter: 15
    section: "15.3"
    thesis_ref: "Definition 15.3.4 (Φ translation)"
    description: >
      Quantifier introduction (O) is not part of Ω in the thesis. The repo
      records these as StepIntro entries in EdgeWitness.ewSteps (from ExpForall)
      and translates them interleaved with Ω segments when constructing Φ(e).
    impact: semantic-neutral
    rationale: >
      Interleaving O with Ω in ewSteps simplifies the single-pass Φ translation
      without changing the resulting instantiation. The 15-row witness matrix
      (R-*) validates that the combined translation produces correct results.
    code_paths:
      - src/MLF/Constraint/Types/Witness.hs
      - src/MLF/Elab/Phi/Translate.hs
    test_evidence:
      - matcher: "R-"
        file: test/Presolution/WitnessSpec.hs
    status: accepted

  - id: DEV-WITNESS-NORM-NO-PROOF
    chapter: 11
    section: "11.5"
    thesis_ref: "Definition 11.5.2 (witness normalization)"
    description: >
      Witness normalization is implemented and tested but not backed by formal
      proofs from the thesis. The implementation follows the thesis conditions
      (weaken-last, no delayed weaken, coalescing) but correctness is
      established by executable tests, not mechanized proof.
    impact: semantic-neutral
    rationale: >
      Executable property proxies and the 15-row witness matrix provide strong
      evidence. Full mechanization is future work.
    code_paths:
      - src/MLF/Constraint/Presolution/WitnessNorm.hs
      - src/MLF/Constraint/Presolution/WitnessCanon.hs
    test_evidence:
      - matcher: "R-"
        file: test/Presolution/WitnessSpec.hs
      - matcher: "Phase 7 theorem obligations"
        file: test/TypeSoundnessSpec.hs
    status: accepted

  - id: DEV-CONSTRAINT-REPR-SIMPLIFIED
    chapter: 9
    section: "9.2"
    thesis_ref: "Definition 9.2.1 (constraint representation)"
    description: >
      The constraint representation mirrors the paper's term-DAG + binding tree
      split (cNodes + cBindParents with BindFlex/BindRigid). Some paper
      machinery is simplified — for example, fallback-removal relies on
      regression tests rather than a separate formal verification step.
    impact: semantic-neutral
    rationale: >
      The representation preserves all semantic information from the thesis.
      Simplifications are covered by regression tests.
    code_paths:
      - src/MLF/Constraint/Types.hs
      - src/MLF/Constraint/Types/Graph.hs
    test_evidence:
      - matcher: "Phase 1"
        file: test/ConstraintGenSpec.hs
    status: accepted

  - id: DEV-PHASE7-NO-FORMAL-LINK
    chapter: 14
    section: "14.3"
    thesis_ref: "Theorems 14.3.1-14.3.2 (preservation, progress)"
    description: >
      The repo includes type-checking and reduction for xMLF
      terms/instantiations (MLF.Elab.TypeCheck, MLF.Elab.Reduce) but lacks a
      fully formalized/verified connection to the thesis proof obligations.
      Evidence is via executable property proxies (preservation, progress,
      determinism, canonical forms) with QuickCheck.
    impact: semantic-neutral
    rationale: >
      Property-based testing with structurally rich generators provides strong
      coverage. Full mechanization (e.g., Agda/Liquid Haskell) is future work.
    code_paths:
      - src/MLF/Elab/TypeCheck.hs
      - src/MLF/Elab/Reduce.hs
    test_evidence:
      - matcher: "Phase 7 theorem obligations"
        file: test/TypeSoundnessSpec.hs
    status: accepted

  - id: DEV-TYEXP-OCCURRENCE-REPR
    chapter: 10
    section: "10.1"
    thesis_ref: "Definition 10.1.1 (expansion variables)"
    description: >
      Expansion variables are represented as TyExp occurrence nodes in the
      constraint graph rather than constructing a separate expansion graph per
      instantiation edge. Presolution materializes and removes them.
    impact: semantic-neutral
    rationale: >
      This is a representation choice that preserves semantics. TyExp nodes
      carry the same ExpVarId and are materialized/eliminated during presolution
      exactly as the thesis describes.
    code_paths:
      - src/MLF/Constraint/Types.hs
      - src/MLF/Constraint/Presolution/Driver.hs
    test_evidence:
      - matcher: "Phase 4"
        file: test/PresolutionSpec.hs
    status: accepted

  - id: DEV-INTERIOR-WIDENING
    chapter: 15
    section: "15.3"
    thesis_ref: "Section 15.3 (elaboration)"
    description: >
      Interior set (I(r)) is widened with reachable scheme interiors to keep
      explicit-forall binders inside instantiation copies. This is a
      preservation measure not stated in the thesis text.
    impact: semantic-minor
    rationale: >
      Without widening, explicit-forall binders can fall outside the interior
      after copy operations, causing Φ translation failures. The widening
      preserves the thesis invariant that operated binders are interior.
    code_paths:
      - src/MLF/Constraint/Presolution/Copy.hs
    test_evidence:
      - matcher: "explicit forall annotation"
        file: test/ElaborationSpec.hs
    status: accepted

  - id: DEV-GEN-FALLBACK-PRESENT
    chapter: 15
    section: "15.3"
    thesis_ref: "Section 15.3.1 (Q(g) computation)"
    description: >
      Gen-ancestor fallback is guarded and inert. The pipeline rejects
      fallback-dependent constraints via checkNoGenFallback (Binding/Validation.hs)
      before Φ translation. Q(g) is computed explicitly: parentRefForBinders
      (Reify/Core.hs) routes scheme roots to GenRef, and bindersForGen
      (Selection.hs) enumerates direct gen-node children. The anticipated
      fallback functions (closestGenAncestor, immediateGen, bindersFromGen)
      never existed in the codebase. tryBound in Phi/Context.hs is
      thesis-correct bound-descent (∀(⩾ C)), not gen-ancestor fallback.
    impact: semantic-neutral
    rationale: >
      checkNoGenFallback rejects any constraint that would require gen-ancestor
      fallback. All 766 tests pass through this gate. Q(g) routing is explicit
      via parentRefForBinders and bindersForGen. No gen-ancestor fallback code
      paths remain active.
    code_paths:
      - src/MLF/Binding/Validation.hs
      - src/MLF/Elab/Phi/Translate.hs
      - src/MLF/Reify/Core.hs
    test_evidence:
      - matcher: "Q(g) returns direct flex children"
        file: test/ElaborationSpec.hs
      - matcher: "rejects fallback-dependent binders"
        file: test/ElaborationSpec.hs
      - matcher: "O15-CONTEXT-REJECT"
        file: test/ElaborationSpec.hs
    status: accepted

  - id: DEV-LET-SCOPE-THREADING-PARTIAL
    chapter: 15
    section: "15.2"
    thesis_ref: "Definition 15.2.10 (alternative let typing)"
    description: >
      Let-scope alternative typing (Def. 15.2.6) is fully implemented.
      Constraint generation produces the rightmost constraint with a trivial
      scheme root and let-expression gen node. Presolution drops trivial
      scheme edges (dropTrivialSchemeEdges) and returns identity expansion.
      Elaboration detects the trivialRoot annotation and strips it
      (Elaborate.hs:835), and letScopeOverrides (Scope.hs:154) computes
      base-vs-solved scope divergence for thesis-aligned generalization.
    impact: semantic-neutral
    rationale: >
      All threading is verified present: trivialRoot flows through constraint
      gen → presolution → elaboration with identity semantics. Scope overrides
      preserve thesis ga′ semantics. Tests cover monomorphic/polymorphic lets,
      nested lets, scope divergence, and translatable presolution validation.
    code_paths:
      - src/MLF/Frontend/ConstraintGen/Translate.hs
      - src/MLF/Constraint/Presolution/Base.hs
      - src/MLF/Elab/Elaborate.hs
      - src/MLF/Elab/Run/Scope.hs
    test_evidence:
      - matcher: "O15-ELAB-LET"
        file: test/ElaborationSpec.hs
      - matcher: "letScopeOverrides"
        file: test/ElaborationSpec.hs
      - matcher: "let-polymorphic"
        file: test/TranslatablePresolutionSpec.hs
    status: accepted

  - id: DEV-P2-SPEC-STUBS-DEFERRED
    chapter: 13
    section: "13.4"
    thesis_ref: "Chapter 13 (constraint simplification)"
    description: >
      P2 backlog spec stub for constraint-simplification-rules has been
      created. The eMLF/iMLF translation spec was deemed unnecessary — the
      pipeline operates on a single constraint representation and does not
      require the eMLF/iMLF distinction.
    impact: semantic-neutral
    rationale: >
      Constraint simplification spec stub is in place with requirements,
      design, and task outline. The core pipeline (Chapters 9-15) is fully
      covered. eMLF/iMLF translation is not needed for the current architecture.
    code_paths: []
    test_evidence: []
    status: accepted
    status: accepted
