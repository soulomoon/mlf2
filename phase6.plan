# Phase 6 — Elaboration to xMLF (paper-faithful, binding-edge model)

Status
------
Implemented in `src/MLF/Elab/Pipeline.hs` + `src/MLF/Elab/Types.hs` (plus tests),
with known paper-alignment gaps tracked in `implementation_notes.md` / `merge_raise_merge_plan.txt`.

Goal
----
Given a solved constraint graph (post-Phase 5) and per-edge witnesses from
presolution (Phase 4), elaborate an eMLF surface term into an explicitly typed
xMLF term as in `papers/xmlf.txt` §3:

  - insert type abstractions `Λ(Q(g))` at generalization sites, and
  - insert explicit instantiations `Φ(e)` at instantiation edges.

Current design (repo)
---------------------
- Binding nodes `g` are represented by `TyForall` nodes plus binding edges
  (`Constraint.cBindParents` with `BindFlex`/`BindRigid`).
- Instance bounds/eliminations are stored in `Constraint.cVarBounds` /
  `Constraint.cEliminatedVars` (`MLF.Constraint.VarStore`), keyed by canonical `NodeId`.
- Presolution records per-edge witnesses as `EdgeWitness` / `InstanceOp` (Ω),
  plus quantifier-introduction steps (`O`) separately as `ewForallIntros`.

What Phase 6 does
-----------------
1. Reify solved graph nodes into xMLF types.
2. Generalize at let binders using the binding tree (`MLF.Binding.Tree.orderedBinders`)
   and bounds/eliminations (`MLF.Constraint.VarStore`) to produce explicit `Λ(α ≥ τ)` binders.
3. Translate per-edge witnesses into xMLF instantiations `φ = Φ(e)` and insert
   them at application sites (repo-specific: function position).

Known gaps / future work
------------------------
- Full Yakobowski’08 witness normalization is not implemented; the repo uses a
  lightweight, ordering-preserving normalization sufficient for current tests.
- The paper’s application elaboration elaborates both sides; the repo currently
  attaches instantiation to the function position only.
- Phase 7 (xMLF typechecker + reduction semantics, `papers/xmlf.txt` Fig. 4/5)
  is not implemented.

References
----------
- `roadmap.md` (high-level pipeline)
- `implementation_notes.md` (paper ↔ repo mapping and alignment notes)
- `papers/xmlf.txt` §3 (elaboration)
