# Revision history for mlf2

## Unreleased

* Defensible exactness: added machine-checked thesis claims registry (`docs/thesis-claims.yaml`, 21 claims) and deviation register (`docs/thesis-deviations.yaml`, 9 deviations) with cross-link validation script (`scripts/check-thesis-claims.sh`); added `supports_claims` back-links to obligations ledger; added three new test modules (`TranslatablePresolutionSpec`, `PhiSoundnessSpec`, `ExpansionMinimalitySpec`) covering Def. 15.2.10, Def. 15.3.4, and Def. 10.1.1; upgraded conformance gate with claims checker and new anchors; migrated paper-map to reference machine-checked artifacts; closed spec drift with deferred notes and deviation cross-references; upgraded three claims from `partial` to `defended`; verification: 765 examples, 0 failures.
* BUG-2026-02-20-001: fixed elaboration-side lambda binder substitution key aliasing so RHS-coercion annotated-let identities no longer leak unresolved `t0` names after `step`; added `PipelineSpec` regression `BUG-2026-02-20-001`.
* Phase 7 theorem obligations: added `/Volumes/src/mlf4/test/TypeSoundnessSpec.hs` with executable property-style preservation/progress proxies over closed well-typed `ElabTerm` values, wired it into `mlf2-test` (`/Volumes/src/mlf4/mlf2.cabal`, `/Volumes/src/mlf4/test/Main.hs`), and enforced it in the thesis gate via `--match "Phase 7 theorem obligations"` in `/Volumes/src/mlf4/scripts/thesis-conformance-gate.sh`.
* Formal obligations ledger: added canonical Chapter 14/15 rule-to-code-to-test inventory (`docs/thesis-obligations-ch14-15.yaml`), generated Markdown view (`docs/thesis-obligations-ch14-15.md`), renderer/checker scripts (`scripts/render-thesis-obligations-ledger.rb`, `scripts/check-thesis-obligations-ledger.sh`), and mandatory hard-fail gate integration in `scripts/thesis-conformance-gate.sh` (exact 61-ID coverage, anchor executability, and markdown drift enforcement).
* Thesis conformance gate: added canonical thesis-anchor command `scripts/thesis-conformance-gate.sh` (Φ/Ω `R-` matrix rows, A6 parity, BUG-2026-02-17-002 strict success, phase-3 equivalence gates, representative theorem baseline) with minimum matched-example thresholds, and added required CI workflow `.github/workflows/thesis-conformance.yml` to enforce `cabal build all` + gate command on push/PR.
* A7 (P2) non-binding dedup closure: added shared test harness pipeline-stage helpers in `test/SpecUtil.hs` (`runConstraintDefault`, `runToPresolutionWithAnnDefault`, `runPipelineArtifactsDefault`) and migrated `PipelineSpec`, `ElaborationSpec`, and `ConstraintGenSpec` off remaining local normalize/solve-chain wrappers, preserving behavior while centralizing helper logic.
* A5 (P3) totality/harness hardening: replaced bare-coercion stringly internal failure with typed `UnexpectedBareCoercionConst`, totalized STCon coercion-copy argument traversal via `internalizeConArgs` (`NonEmpty` recursion), consolidated presolution harness wiring through `PresolutionSpec`, and added fail-fast harness guard in `test/Main.hs` so omitted umbrella wiring aborts test execution.
* BUG-2026-02-17-002 closure: fixed applied bounded/coercion A6 mismatch by aligning annotated-lambda let fallback and application instantiation recovery in `MLF.Elab.Elaborate`; converted the `PipelineSpec` sentinel into a strict success assertion (`Int`) and moved the bug to resolved in `Bugs.md`.
* A6 (P2) parity/regression coverage: expanded bounded/coercion-heavy checked-vs-unchecked parity tests in `test/PipelineSpec.hs`, `test/TypeCheckSpec.hs`, and `test/ReduceSpec.hs`, including `typeCheck` agreement and normalization-preservation checks for elaborated terms.
* A3 (P2) API cleanup: quarantined legacy elaboration conversion by removing `expansionToInst` from `MLF.Elab.Pipeline` exports; legacy helper remains in `MLF.Elab.Legacy`, with public client surfaces unchanged (`MLF.API`, `MLF.Pipeline`).
* A1 closure audit: verified strict Ω merge-direction behavior end-to-end (`normalizeInstanceOpsFull` + `normalizeEdgeWitnessesM`) and closed the A1 tracker entries with targeted regression evidence (`R-MERGE-NORM-09`, presolution fail-fast matcher) plus full gate pass (`cabal build all && cabal test`).
* BUG-2026-02-17-001 closure: finished Φ/Ω residual contract fixes by (1) enforcing `resolveTraceBinderTarget` fail-fast invariant errors for trace-source binder ops without replay binder candidates, (2) restoring non-spine `OpRaise` context-path translation for non-`⊥` bounds when `C^m_n` exists, and (3) tightening the `PipelineSpec` canonicalization sentinel to avoid hard-coded non-empty union-find assumptions; full gate is green (`cabal build all && cabal test`, `678 examples, 0 failures`).
* BUG-2026-02-16-010 (partial closure): normalized replay-key contracts end-to-end across presolution traces/hints (`etBinderReplayHints` restore/usage), Φ bridge construction, and Ω binder target lookup; fixed deterministic BUG-002 matrix replay drift (`BUG-002-V1..V4` with seed `1593170056`) and added reify-time self-bound normalization (`a` in its own bound -> `⊥`) to keep scheme bounds well-formed without weakening alias-bound rejection.
* BUG-2026-02-16-001/002: fixed planner-time scheme-owner lookup crash on synthesized-wrapper edge-classification fixtures by making `planEdge` resolve scheme introducers robustly (body-root first, wrapper-root fallback for synthesized `ExpVarId`s only); strengthened `EdgePlannerSpec` let/ann regressions to assert both flag threading and resolved `eprSchemeOwnerGen`.
* BUG-2026-02-11-004: fixed BUG-003 bounded-alias closure by guarding edge-local self-class RaiseMerge emission and skipping same-root bound writes in `MLF.Constraint.Presolution.EdgeUnify`; added `BUG-003-PRES` regression to assert edge-0 presolution leaves no self-bound binder metas, and revalidated `BUG-003-V*` + strict anchors green.
* BUG-2026-02-11-004/BUG-2026-02-16-010 (partial, historical intermediate): added presolution replay-hint metadata (`EdgeTrace.etBinderReplayHints`) and normalization-time hint derivation/validation, plus positional replay seeding in `computeTraceBinderReplayBridge`; strict matrix `make-app` bridge guard is green again.
* BUG-2026-02-11-004 (partial, historical intermediate): added a deterministic Φ→Ω binder bridge (`ocTraceBinderSources` + `ocTraceBinderReplayMap`) and fail-fast replay-contract checks for binder-target ops (`OpGraft` target, `OpWeaken`, `OpRaise` execution target, `OpMerge`, `OpRaiseMerge`); missing source→replay mappings now raise `PhiInvariantError` with edge/op/key-space diagnostics, with new focused regression coverage in `test/ElaborationSpec.hs`.
* BUG-2026-02-16-007/008: fixed BUG-003 sentinel drift from `SchemeFreeVars (__rigid24)` by aligning pipeline/result-type generalization fallback with elaboration fallback (`SchemeFreeVars` + `BindingTreeError GenSchemeFreeVars` both retry through non-GA and final `reifyType` fallback); BUG-003 sentinels now track the stabilized strict-instantiation bucket (`InstBot expects TBottom`) instead of transient scope-closure noise.
* BUG-2026-02-16-009: fixed explicit-forall let-bound round-trip failure by adding a non-spine `OpRaise` source-target fallback in `MLF.Elab.Phi.Omega`; Ω still prefers copy-map adopted targets, but when adopted-target context/root insertion is unavailable it retries root insertion with the source-domain raise target, eliminating `OpRaise (non-spine): missing computation context` while keeping BUG-004/BUG-002 anchors green.
* BUG-2026-02-16-003/004/005/006: fixed `id id` let-polymorphism regression by stopping `AAppF.argInstFromFun` from inlining inferred meta-var instantiation arguments (`inlineBoundVarsType`); this preserves the solver-selected instantiation variable and prevents argument-side over-specialization (`TCArgumentMismatch`) while restoring redirected let-use, checked-authoritative replay, dual-instantiation elaboration, and paper baseline `let id = (\\x. x) in id id`.
* BUG-2026-02-11-003 (2026-02-12 update): corrected instantiation production for BUG-004-V2/V4 — tightened Omega.hs bare `InstBot` to require `TBottom` input, collapsed trivially bounded foralls in ALamF, and normalized argument instantiation to `InstElim`/`InstId` when annotation already updated the bound; strict `InstBot` checker semantics are unchanged; added 3 strict InstBot regression tests (`652 examples, 0 failures`).
* BUG-2026-02-11-003: completed thesis-exact closure for BUG-004 nested-annotation variants by enforcing strict-only `InstBot` semantics (compat mode removed), deleting non-thesis reify fallback instantiation synthesis, normalizing bounded inferred argument instantiation (`InstApp τ` → `InstElim` when argument is already `∀(⩾ τ)`), and replacing bounded-identity lambda-annotation recovery with explicit coercion-domain form matching; `BUG-004-V2/V4` (including strict-shadow checks) are green in checked and unchecked pipelines.
* Tests/bug-tracking: added systematic variant matrix coverage in `test/ElaborationSpec.hs` (`BUG-002-V*`, `BUG-003-V*`, `BUG-004-V*`) and `test/Presolution/WitnessSpec.hs` (`US-010-V*`); confirmed new regressions on extended factory/bounded-alias/annotated-call-site paths and opened `BUG-2026-02-11-002`..`004` in `Bugs.md` with sentinel assertions and repro commands.
* Tests/bug-tracking: hardened `Phase 3 atomic wrapping equivalence gates` by removing permissive mismatch fallback and enforcing explicit `forall a. a -> a` identity-shape assertions; revalidated targeted bug suites plus full gate (`633 examples, 0 failures`) and synced `BUG-2026-02-06-002`/`BUG-2026-02-08-004` to resolved in `Bugs.md`.
* Cleanup: removed the single-constructor `EdgeStage` phantom index and `edgePlanStage`; `EdgePlan` is now a concrete resolved record with simplified planner/interpreter signatures, with no behavior change.
* Phase 6 bridge-removal polish: removed the dedicated synthesized-wrapper interpreter bridge function in favor of a unified TyExp expansion execution path, added wrapper-identity characterization coverage, and re-validated Phase-3 equivalence gates plus full suite (`631 examples, 0 failures`).
* Phase 5 abstraction polish: removed runtime edge-plan mode tagging in favor of refined `ResolvedTyExp` payloads, replaced planner TyExp-left invariant strings with structured `ExpectedTyExpLeftInPlanner` errors, centralized synthesized-wrapper `ExpVarId` allocation/checks in `MLF.Constraint.Types.SynthesizedExpVar`, and kept gate verification green.
* Phase 4 typed-two-pass closeout: introduced phase-tagged presolution errors (`PlanError`/`ExecError`), added regression-matrix coverage across Expansion/EdgeTrace/Witness/Pipeline specs (including annotation-edge weaken suppression), and verified full gate green (`cabal build all && cabal test` => `630 examples, 0 failures`).
* Phase 3 typed-two-pass rollout: restored wrapping equivalence by reserving negative `ExpVarId`s for synthesized wrappers, dispatching wrapper semantics via `ExpVarId < 0`, and adding a Phi order-key fallback to avoid false `PhiReorder` invariant failures under wrapped edge shape; gate suite + full test matrix are green (`626 examples, 0 failures`).
* Witness normalization/translatability: enforced Fig. 15.3.4 transitive-flex guard for non-rigid `OpRaise` in `WitnessValidation`; added dedicated direct + presolution-path regressions, and updated merge-emission coverage to assert fast failure on non-translatable escaped bounded-binder raises.
* Witness matrix closure: completed Fig. 15.3.4 15-row normalization/emission matrix (`R-GRAFT-VALID-01`..`R-RAISEMERGE-NORM-15`) with explicit row-labeled tests across `test/Presolution/WitnessSpec.hs` and `test/Presolution/MergeEmissionSpec.hs`; matrix gate (`--match R-`) and full gate (`cabal build all && cabal test`) are green.
* BUG-2026-02-06-002: completed thesis-exact upstream graft/weaken closure (witness canonicalization + Ω localization + named-bound simplification guard + let-lambda fallback harmonization); strict bug matrix and full gate are green (`cabal build all && cabal test` => `604 examples, 0 failures`).
* BUG-2026-02-08-004: fixed nested let + annotated-lambda checked-authoritative path in `MLF.Elab.Elaborate` by guarding `InstApp` against non-∀ function terms and by extending polymorphic-argument instantiation inference to typed post-instantiation function arrows; dedicated `PipelineSpec` sentinel now asserts thesis-green `Int` for unchecked + checked pipeline.
* Witness normalization: condition-(5) delayed-weaken ordering now reports a dedicated `DelayedWeakenViolation` instead of overloading `OpUnderRigid`; added focused witness-spec regressions for delayed-weaken violation and delayed graft/weaken coalescing behavior.
* BUG-2026-02-06-002: retained C18/C21/C21.1 elaboration-path fixes (`Phi.Omega` delayed graft/weaken handling + `Elaborate` let-scheme/app-inst repair), graduated the 4-case sentinel matrix to strict assertions, and brought the full `BUG-2026-02-06-002` matcher to green (`10 examples, 0 failures`).
* Elaboration/typecheck: fixed H15 lambda-parameter source selection in `MLF.Elab.Elaborate` so unannotated nested lambdas no longer leak solved-node names (e.g. `t23`) into let-RHS types; added `PipelineSpec` regression `does not leak solved-node names in make let mismatch`.
* Planning/docs: selected Option 1 (upstream witness-shape correction) for `BUG-2026-02-06-002`, added design/execution plans under `docs/plans/2026-02-09-*witness-shape-correction*`, and kept the 4-case bug sentinel matrix explicitly pending until strict closure tests are green.
* Binding/docs: documented A7 Group 1 shared-helper consolidation; duplicated binding path/node-ref/scope/children helpers are canonicalized in `MLF.Binding.Path`, `MLF.Binding.NodeRefs`, `MLF.Binding.ScopeGraph`, and `MLF.Binding.Children`, with migrations in `MLF.Binding.Queries`, `MLF.Binding.Validation`, `MLF.Binding.Tree`, `MLF.Binding.Canonicalization`, `MLF.Constraint.BindingUtil`, and `MLF.Constraint.Presolution.Base`.
* Tests: finalized A7 shared harness dedup by centralizing shared pipeline test helpers in `test/SpecUtil.hs` and removing duplicate helper paths across `PipelineSpec`, `ElaborationSpec`, and `ConstraintGenSpec` without behavior changes.
* Tests/docs: `PipelineSpec` rewrite regression now exercises both `applyRedirectsToAnn` and `canonicalizeAnn` so every node occurrence (including `ALet` scheme roots) is rewritten, and `docs/plans/2026-02-08-a7-group-2-frontend-elab-abstractions-implementation-plan.md` now lists a single Hspec filter that hits Pipeline/Phase 1/Phase 6 examples.
* Frontend syntax/pretty: consolidated raw and normalized frontend type syntax into indexed `SrcTy` (`SrcNorm`, `SrcTopVar`, `SrcBound`) with compatibility aliases (`SrcType`, `NormSrcType`, `StructBound`), and generalized pretty entry points to staged types (`prettyEmlfType :: SrcTy n v -> String`, `prettyEmlfExpr :: Expr 'Surface (SrcTy n v) -> String`).
* Frontend/elab abstractions: deduplicated frontend scope-wiring in `ConstraintGen.Translate` via local helpers (`withScopedBuild`, `attachUnder`, `rebindScopeRoot`) and centralized AnnExpr node traversal in `MLF.Elab.Run.Annotation.mapAnnNodes` (reused by redirect/canonicalization/debug origin utilities).
* Frontend/pipeline: introduced staged raw vs normalized frontend types and parser entrypoints (`parseRaw*`/`parseNorm*`), and made desugaring/constraint generation/pipeline entrypoints normalized-input only.
* Frontend/normalization: removed the reachable `normalizeBound` runtime crash path by reporting `NonStructuralBoundInStructContext`, and completed the parser clean break by removing legacy `parseEmlf*` compatibility aliases.
* Presolution/elaboration: RaiseMerge gating now uses live structural graph state (no binder-bound snapshots), preserving witness normalization/translatability invariants while restoring bounded aliasing baseline elaboration (`∀a. a -> a -> a`) in both checked and unchecked pipelines.
* Presolution: witness normalization is strict for malformed merge direction (`MergeDirectionInvalid`) across helper and production paths; permissive merge-direction fallback was removed entirely.
* Elaboration/generalization: fixed a Phase 6 `MissingNode` crash by guarding base-constraint reification against stale `solvedToBasePref` targets in `reifyWithGaBase`; when the base node is absent, elaboration now falls back to solved-order reification.
* Tests: added `BUG-2026-02-06-001` regression coverage to ensure nested let + annotated-lambda application no longer fails in Phase 6.
* Pipeline: `runPipelineElab` now reports the checked type (`typeCheck term`) as authoritative; reconstructed result-type paths are retained for diagnostics.
* Generalize: solved-order is runtime-authoritative in fallback reification; runtime base-path shadow reify/compare was removed after the 5/5 gate pass.
* Generalize shadow comparator: solved/base mismatch still hard-fails with `ValidationFailed` plus context payload in focused comparator helpers/tests.
* Pipeline: when root generalization yields no binders but the elaborated term remains type-open, top-level closure now quantifies checked free type variables before final type checking.
* Elaboration: shared closure logic now alpha-freshens wrapper binders against nested `ETyAbs` binders and rewrites free type-variable occurrences in term-level types/instantiations to avoid capture.
* Annotation elaboration: annotation-bound alignment now prefers generalized annotation bounds when shaping `InstInside (InstBot ...)` updates.
* Tests: strict checked-authoritative baselines were updated (including top-level `ETyAbs` wrappers and authoritative `Bool` result cases), with bounded aliasing Merge/RaiseMerge still tracked as a known expected-failure gap.
* Frontend: added eMLF parser + pretty-printer (`MLF.Frontend.Parse`, `MLF.Frontend.Pretty`) and public API entry points (`parseRawEmlfExpr`, `parseRawEmlfType`, `parseNormEmlfExpr`, `parseNormEmlfType`, `prettyEmlfExpr`, `prettyEmlfType`).
* xMLF syntax: added dedicated parser/pretty modules (`MLF.XMLF.Syntax`, `MLF.XMLF.Parse`, `MLF.XMLF.Pretty`) and new public module `MLF.XMLF`.
* Pretty migration: `MLF.Elab.Types.Pretty` now renders through canonical xMLF syntax printers (Unicode-first, canonical computation forms such as `ε`, `⊲σ`, `α⊳`), with tests updated accordingly.
* Docs/tests: added `docs/syntax.md` as syntax source of truth and added parser/pretty coverage specs (`FrontendParseSpec`, `FrontendPrettySpec`, `XMLFParseSpec`, `XMLFPrettySpec`).

## 0.2.0.0 -- 2026-02-02

* Breaking: pipeline entry points now return `PipelineError` and provide config-aware variants (`runPipelineElabWithConfig`, `runPipelineElabCheckedWithConfig`).
* Breaking: tracing is fully explicit (no global trace config); `PipelineConfig`/`TraceConfig` are part of the public API.
* Breaking: constraint types are split into `MLF.Constraint.Types.Graph`, `MLF.Constraint.Types.Witness`, and `MLF.Constraint.Types.Presolution` (imports updated accordingly).

## 0.1.0.0 -- YYYY-mm-dd

* First version. Released on an unsuspecting world.
